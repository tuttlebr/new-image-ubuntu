---
- hosts: gpus
  become: true
  ignore_errors: true
  tags:
  - Version_460.84
  - Release_Date_2021.6.3
  - Operating_System_Linux 64-bit
  - Language_English_US
  - File Size_169.6MB
  tasks:
    - name: disable nouveau driver 1
      ansible.builtin.command: bash -c "echo blacklist nouveau > /etc/modprobe.d/blacklist-nvidia-nouveau.conf"
    - name: disable nouveau driver 2
      ansible.builtin.command: bash -c "echo options nouveau modeset=0 >> /etc/modprobe.d/blacklist-nvidia-nouveau.conf"
    - name: Reboot the server for modprobe changes
      reboot:
    - name: download driver install runfile
      get_url:
        url: https://us.download.nvidia.com/XFree86/Linux-x86_64/460.84/NVIDIA-Linux-x86_64-460.84.run
        dest: /root/NVIDIA-Linux-x86_64-460.84.run
        mode: '0100'
        force: true
        checksum: md5:629d4f2a0d6f593aa4cf9b73983d3c8b
    - name: execute installation script
      ansible.builtin.command: /root/NVIDIA-Linux-x86_64-460.84.run --silent
    - name: test nvidia-smi
      command: nvidia-smi
      changed_when: false
      when:
        - ansible_local['gpus']['count']
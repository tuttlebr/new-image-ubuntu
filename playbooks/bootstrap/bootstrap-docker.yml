---
- hosts: all
  name: Setup Docker
  become: true
  become_user: {{ ansible_user }}
  ignore_errors: true
  tags:
  - docker
  tasks:
    - name: download docker
      get_url:
        url: https://get.docker.com
        force: true
        dest: /root/get-docker.sh
        mode: '0100'
    - name: install docker
      ansible.builtin.command: /root/get-docker.sh
    - name: set docker user permissions
      ansible.builtin.command: usermod -aG docker {{ ansible_user }}
    - name: download docker-compose
      get_url:
        url: https://github.com/docker/compose/releases/download/1.29.2/run.sh
        force: true
        dest: /usr/bin/docker-compose
        mode: '0100'
    - name: install custom facts module
      include_role:
        name: facts
      when: docker_install | default('yes')
    - name: remove docker overrides
      file:
        path: /etc/systemd/system/docker.service.d/docker-override.conf
        state: absent
    - name: install nvidia-docker
      include_role:
        name: nvidia.nvidia_docker